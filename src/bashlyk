#!/bin/bash
#
# $Id: bashlyk 715 2017-03-27 17:10:24+04:00 toor $
#
#****h* BASHLYK/bashlyk
#  DESCRIPTION
#    bashlyk - загрузчик BASHLYK-библиотек. Готовит структуру служебных
#    каталогов и файлов, определяет интерактивность запущенного сценария,
#    позволяет выполнить тестовый модуль библиотек
#  AUTHOR
#    Damir Sh. Yakupov <yds@bk.ru>
#******
#***iV* bashlyk/BASH Compatibility
#  DESCRIPTION
#    BASH version 4.xx or more required for this script
#  SOURCE
[ -n "$_BASHLYK" ] && return 0 || _BASHLYK=1
[ -n "$BASH_VERSION" ] && (( ${BASH_VERSINFO[0]} >= 4 )) || eval '             \
                                                                               \
    echo "[!] BASH shell version 4.xx required for ${0}, abort.."; exit 255    \
                                                                               \
'
#******
#****G* bashlyk/Global variables
#  DESCRIPTION
#    global variables of the library
#  SOURCE
[[ -s "/etc/bashlyk/bashlyk.conf" ]] && . /etc/bashlyk/bashlyk.conf
: ${_bashlyk_aLib:="std,err,pid,cnf,ini,opt,log,net,csv,msg"}
: ${_bashlyk_pathLib:="/usr/share/bashlyk"}
: ${_bashlyk_s0:=${0##*/}}
: ${_bashlyk_sArg:="$@"}
: ${_bashlyk_bInteract:=1}
: ${_bashlyk_bTerminal:=1}
: ${_bashlyk_sCond4Log:=noterm}
: ${_bashlyk_bNotUseLog:=0}
: ${USER:=$( exec -c id -nu )}
: ${_bashlyk_sUser:=$USER}
: ${_bashlyk_sGroup:=$( exec -c id -ng )}
: ${_bashlyk_ShellVersion:=$(                                                  \
    printf '%d%03d%03d'                                                        \
           "${BASH_VERSINFO[0]}"                                               \
           "${BASH_VERSINFO[1]}"                                               \
           "${BASH_VERSINFO[2]}"                                               \
    )                                                                          \
}
#******
#****f* bashlyk/udfInit
#  SYNOPSIS
#    udfInit
#  DESCRIPTION
#    Подготовка к запуску сценария, определение условий его работы (каталоги
#    расположения создаваемых файлов, наличие терминала, перенаправления и т.п.)
#    Если запуск выполняется от "root", то каталоги располагаются глобально,
#    согласно стандарта FHS, иначе - в каталогах согласно XDG Base Directory
#    Specification.
#    В случае, если не удалось определить владельца процесса или отсутствует
#    домашний каталог, то иерархия объектов сценария создаются в глобальном
#    временном каталоге, обычно /tmp
#  SOURCE
udfInit() {

  local pathCnf pathRoot pathRun pathLog pathDat sHome IFS=$' \t\n'


  if [[ $_bashlyk ]]; then

    _bashlyk_sId="$_bashlyk"
    _bashlyk_pathPrefix="$_bashlyk"

  else

    _bashlyk_sId=${_bashlyk_s0%.sh}
    _bashlyk_pathPrefix='bashlyk'

  fi

  case $_bashlyk_sUser in

    'root')

            _bashlyk_pathCnf="/etc/${_bashlyk_pathPrefix}"
            _bashlyk_pathIni="/etc/${_bashlyk_pathPrefix}"
            _bashlyk_pathRun="/var/run/${_bashlyk_pathPrefix}"
            _bashlyk_pathLog="/var/log/${_bashlyk_pathPrefix}"
            _bashlyk_pathDat="/var/lib/${_bashlyk_pathPrefix}"
            [[ -s "/etc/${_bashlyk_pathPrefix}/bashlyk.conf" ]] \
             && . "/etc/${_bashlyk_pathPrefix}/bashlyk.conf"
    ;;

         *)
            if [[ -z "$HOME" || ! -O "$HOME" ]]; then

              sHome=$(getent passwd $_bashlyk_sUser | cut -d ":" -f 6)
              [[ $sHome && -d "$sHome" && -O "$sHome" ]] || \
               sHome="/tmp/${$}_${_bashlyk_sUser}"

            else

              sHome=$HOME

            fi

            _bashlyk_pathRun="${sHome}/.cache/${_bashlyk_pathPrefix}/run"
            _bashlyk_pathLog="${sHome}/.local/share/${_bashlyk_pathPrefix}/log"
            _bashlyk_pathDat="${sHome}/.local/share/${_bashlyk_pathPrefix}/lib"
            _bashlyk_pathCnf="${sHome}/.config/${_bashlyk_pathPrefix}"
            _bashlyk_pathIni="${sHome}/.config/${_bashlyk_pathPrefix}"

            [[ -s "${sHome}/.config/bashlyk/bashlyk.conf" ]] \
              && . "${sHome}/.config/bashlyk/bashlyk.conf"

            [[ -s "${sHome}/.config/${_bashlyk_pathPrefix}/bashlyk.conf" ]] \
              && . "${sHome}/.config/${_bashlyk_pathPrefix}/bashlyk.conf"

         ;;
  esac

  [[ -t 1 ]] && _bashlyk_bInteract=1 || _bashlyk_bInteract=0
  tty > /dev/null 2>&1 && _bashlyk_bTerminal=1 || _bashlyk_bTerminal=0

  if [[ "$_bashlyk_sArg" =~ bashlyk-test ]]; then

    _bashlyk_aUnit="$(echo "${_bashlyk_sArg#*--bashlyk-test=}" | cut -f1 -d' ' \
      | tr ',' ' ' | grep -v '\-\-bashlyk-test')"

    [[ $_bashlyk_aUnit ]] || _bashlyk_aUnit="$(echo $_bashlyk_aLib|tr ',' ' ')"

    _bashlyk_sMode='test'

    export _bashlyk_pathIni _bashlyk_pathRun _bashlyk_pathDat _bashlyk_pathLog \
           _bashlyk_sLogin _bashlyk_bUseMail _bashlyk_sUser _bashlyk_sGroup    \
           _bashlyk_ShellVersion

  else

    _bashlyk_sMode='lib'

  fi

  [[ $_bashlyk_aUnit ]] || _bashlyk_aUnit="${_bashlyk_aLib//,/ }"

}
#******
#****f* bashlyk/udfMain
#  SYNOPSIS
#    udfMain
#  DESCRIPTION
#    Инициализация, подключение модулей, запуск процесса протоколирования
#    в случае наличия перенаправления стандартных устройств или потери терминала
#    в зависимости от значения $_bashlyk_sCond4Log ("noterm" по умолчанию).
#  SOURCE
udfMain() {

  local cmd fn s IFS=$' \t\n'

  udfInit

  if [[ "$_bashlyk_sMode" == "test" ]]; then

    cmd=${_bashlyk_pathLib}/testunit.sh

    [[ -x "$cmd" ]] || eval 'echo "Error: $cmd not found..."; exit 255'

    for s in $_bashlyk_aUnit; do $cmd $s; done

    exit $?

  else

    for s in $_bashlyk_aUnit; do

      fn=${_bashlyk_pathLib}/lib${s}.sh
      [[ -s "$fn" ]] && . $fn || eval 'echo "Error: $fn not found..."; exit 255'

    done

  fi

  unset _bashlyk_aUnit _bashlyk_sMode

  [[ $_bashlyk_log == "nouse" ]] && return 0

  case ${_bashlyk_sCond4Log} in

    redirect) _bashlyk_bNotUseLog=$_bashlyk_bInteract ;;
      noterm) _bashlyk_bNotUseLog=$_bashlyk_bTerminal ;;
           *) _bashlyk_bNotUseLog=$_bashlyk_bInteract ;;

  esac

  [[ "$_bashlyk_bNotUseLog" != "0" ]] || udfSetLog

  return 0

}
#******
#****** bashlyk/Main section
#  DESCRIPTION
#    Вызов udfMain - подключение системы BASHLYK к сценарию
#  SOURCE
udfMain
#******
